#cloud-config

write_files:
- path: /opt/bin/digital_ocean_floating_ip.sh
  permissions: 0755
  owner: root
  content: |
    #!/bin/sh
    IP=$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/anchor_ipv4/address)
    /usr/bin/ip addr add $IP/16 dev eth0

coreos:
  units:
  - name: digital-ocean-floating-ip.service
    command: start
    content: |
      [Unit]
      Description=digital-ocean-floating-ip
      After=network-online.target
      Description=DigitalOcean Floating IP
      Documentation=https://www.digitalocean.com/community/tutorials/how-to-enable-floating-ips-on-an-older-droplet#coreos
      Requires=network-online.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/opt/bin/digital_ocean_floating_ip.sh

  - name: nginx.service
    command: restart
    content: |
      [Unit]
      Description=nginx
      After=docker.service
      Requires=docker.service

      [Service]
      KillMode=none
      User=core
      Restart=always
      RestartSec=20s

      ExecStartPre=-/usr/bin/docker kill nginx
      ExecStartPre=-/usr/bin/docker rm nginx
      ExecStart=/usr/bin/docker run --name nginx -p 80:80 -v /var/run/docker.sock:/tmp/docker.sock:ro jwilder/nginx-proxy
      ExecStop=/usr/bin/docker stop nginx

  - name: pressora.service
    command: restart
    content: |
      [Unit]
      Description=pressora
      After=docker.service
      Requires=docker.service

      [Service]
      KillMode=none
      User=core
      Restart=always
      RestartSec=20s
      Environment="VIRTUAL_HOST=pressora.macacomaluco.space"
      Environment="VIRTUAL_PORT=80"

      ExecStartPre=-/usr/bin/docker kill pressora
      ExecStartPre=-/usr/bin/docker rm pressora
      ExecStart=/usr/bin/docker run --name pressora -e VIRTUAL_HOST -e VIRTUAL_PORT macacomaluco/pressora
      ExecStop=/usr/bin/docker stop pressora
